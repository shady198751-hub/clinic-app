<script>
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø¬Ø¯ÙˆÙ„ Ø¹Ù…Ù„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ (0=Ø§Ù„Ø£Ø­Ø¯, 6=Ø§Ù„Ø³Ø¨Øª)
    // ğŸ›‘ ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªØ·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (Select) ÙˆÙÙŠ DOCTOR_LIMITS ÙÙŠ Ù…Ù„Ù server.js
    const DOCTOR_SCHEDULES = {
        "Ø¯ÙƒØªÙˆØ± Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯": [6, 1, 3], 
        "Ø¯ÙƒØªÙˆØ± Ù†Ø´ÙˆÙŠ Ø§Ø³Ø§Ù…Ù‡": [0, 3, 4, 5], 
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        const form = document.getElementById('booking-form');
        const submitBtn = document.getElementById('submitBtn');
        const buttonText = document.getElementById('button-text');
        const statusMessage = document.getElementById('status-message');
        
        const successModal = document.getElementById('success-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const bookedDetails = document.getElementById('booked-details');

        const dateInput = document.getElementById('date');
        const doctorSelect = document.getElementById('doctorName');
        const scheduleFeedback = document.getElementById('schedule-feedback');
        
        const REDIRECT_URL = 'https://tabarakmariouteya.site/'; 

        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);


        // ğŸŸ¢ Ø±Ø§Ø¨Ø· Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Endpoint) Ø§Ù„Ø¢Ù…Ù† ÙˆØ§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (HTTPS)
        const VPS_ENDPOINT_URL = 'https://c.tabarakmariouteya.site/process-booking'; 
        
        // ğŸŸ¢ Ù…Ø¹Ø±Ù‘ÙØ§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (Entry IDs) Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.
        const FORM_FIELDS = {
            fullName: 'entry.1099054873',
            phone: 'entry.1290164613',
            date: 'entry.1192964186',
            fileNumber: 'entry.1482290468',
            doctorName: 'entry.1102654140'
        };

        const DAYS_OF_WEEK = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];


        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ§ÙÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨
        const validateSchedule = () => {
            const selectedDate = dateInput.value;
            const selectedDoctor = doctorSelect.value;
            
            if (!selectedDoctor || !selectedDate) {
                scheduleFeedback.classList.add('hidden');
                submitBtn.disabled = true; 
                return false; 
            }

            const dateObj = new Date(selectedDate + 'T00:00:00'); 
            const dayOfWeek = dateObj.getDay(); 
            const doctorSchedule = DOCTOR_SCHEDULES[selectedDoctor];
            
            let isValid = false;
            let availableDaysText = '';

            if (doctorSchedule) {
                if (doctorSchedule.includes(dayOfWeek)) {
                    isValid = true;
                }

                const availableDays = doctorSchedule.map(dayIndex => DAYS_OF_WEEK[dayIndex]).join('ØŒ ');
                availableDaysText = availableDays;
            } else {
                isValid = false; 
                availableDaysText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø¨ÙŠØ¨ Ø¢Ø®Ø±.'; 
            }

            scheduleFeedback.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-700');
            scheduleFeedback.classList.add('p-3', 'rounded-lg', 'text-sm', 'text-right', 'mt-4', 'flex', 'items-center');

            if (isValid) {
                scheduleFeedback.classList.remove('bg-red-100', 'text-red-800');
                scheduleFeedback.classList.add('bg-green-100', 'text-green-700');
                scheduleFeedback.innerHTML = `<i data-lucide="check-circle" class="icon-size ml-2"></i> Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø².`;
                submitBtn.disabled = false;
            } else {
                scheduleFeedback.classList.remove('bg-green-100', 'text-green-700');
                scheduleFeedback.classList.add('bg-red-100', 'text-red-800');
                scheduleFeedback.innerHTML = `<i data-lucide="x-circle" class="icon-size ml-2"></i> Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø¬Ø². Ù…ÙˆØ§Ø¹ÙŠØ¯ ${selectedDoctor} Ø§Ù„Ù…ØªØ§Ø­Ø© Ù‡ÙŠ: <span class="font-bold">${availableDaysText}</span>`;
                submitBtn.disabled = true;
            }
            lucide.createIcons();
            return isValid;
        };

        dateInput.addEventListener('change', validateSchedule);
        doctorSelect.addEventListener('change', validateSchedule);
        validateSchedule();


        const showSuccessModal = (date, doctor) => {
            const dateParts = date.split('-'); 
            const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; 

            bookedDetails.textContent = `${formattedDate} - ${doctor}`;
            successModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        const hideSuccessModal = () => {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                successModal.classList.add('hidden');
                window.location.href = REDIRECT_URL; 
            }, 300); 
        };

        closeModalBtn.addEventListener('click', hideSuccessModal);
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                hideSuccessModal();
            }
        });

        const showStatusMessage = (message, type) => {
            statusMessage.innerHTML = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-800');
            }
            statusMessage.classList.remove('hidden');
        };
        
        const submitFormToVPS = async (formData) => {
            const bookingData = {};
            for (const [key, value] of formData.entries()) {
                bookingData[key] = value;
            }
            
            // ğŸ›‘ ØªØ­ÙˆÙŠÙ„ Ø­Ù‚Ù„ 'fullName' Ù…Ù† Ø§Ù„Ù€ HTML Ø¥Ù„Ù‰ 'childName' Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ÙƒÙˆØ¯ server.js
            // (Ø¨Ù…Ø§ Ø£Ù† ÙƒÙˆØ¯ server.js ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹)
            bookingData.childName = bookingData.fullName; 
            delete bookingData.fullName;

            try {
                const response = await fetch(VPS_ENDPOINT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        booking: bookingData, 
                        form_fields: FORM_FIELDS 
                    })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    showSuccessModal(bookingData.date, bookingData.doctorName);
                    form.reset();
                    validateSchedule();
                    showStatusMessage('', 'success'); 

                } else if (result.status === 'full') {
                    // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬Ø² (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ ØªØ¬Ø§ÙˆØ² 20 Ø£Ùˆ 40)
                    const message = `Ù„Ù„Ø£Ø³ÙØŒ Ø§ÙƒØªÙ…Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø·Ø¨ÙŠØ¨. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ ${result.limit}`;
                    showStatusMessage(message, 'error');

                } else {
                    const message = result.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¬Ø².';
                    showStatusMessage(message, 'error');
                }

            } catch (error) {
                console.error('Submission Error:', error);
                let errorMessage = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©: ÙØ´Ù„ ØªÙˆØ¬ÙŠÙ‡ HTTPS. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Nginx ÙŠØ¹Ù…Ù„ Ù„Ù€ ${new URL(VPS_ENDPOINT_URL).hostname}.`;
                showStatusMessage(errorMessage, 'error'); 
            } finally {
                submitBtn.disabled = false;
                buttonText.textContent = 'ØªØ£ÙƒÙŠØ¯ ÙˆØ­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯';
            }
        };


        const submitHandler = (e) => {
            e.preventDefault();
            
            if (!validateSchedule() || submitBtn.disabled) {
                showStatusMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® ÙˆØ·Ø¨ÙŠØ¨ Ù…ØªØ§Ø­ÙŠÙ† Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ø¬Ø².', 'error');
                return;
            }

            statusMessage.classList.add('hidden');
            submitBtn.disabled = true;
            buttonText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            const formData = new FormData(form);
            submitFormToVPS(formData);
        };

        form.addEventListener('submit', submitHandler);
        validateSchedule();
    });
</script>
